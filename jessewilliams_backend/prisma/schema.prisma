// Prisma schema file with Chat History Support
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

enum OrderStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum PlanDuration {
  MONTHLY
  ANNUAL
}

enum FeedbackRating {
  GOOD
  BAD
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  fullName      String?
  role          UserRole @default(USER)
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  verificationToken String?
  verificationTokenExpiry DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  subscriptions UserSubscription[]
  orders        Order[]
  apiKeys       ApiKey[]
  profile       UserProfile?
  chatFeedback  ChatFeedback[]
  chatSessions  ChatSession[]      // âœ… NEW: User's chat sessions
  
  @@map("users")
}

model UserProfile {
  id                  String   @id @default(uuid())
  userId              String   @unique
  
  // Onboarding Data
  propertyType        String
  strategy            String
  rentalType          String?
  startingCapital     Decimal  @db.Decimal(12, 2)
  targetGeography     String
  investmentTimeline  String
  profitGoal          Decimal  @db.Decimal(12, 2)
  
  // Additional Context
  riskTolerance       String?
  experience          String?
  preferences         Json?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_profiles")
}

model GptProduct {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String  @db.Text
  features    Json?   
  icon        String? 
  isActive    Boolean @default(true)
  isFeatured  Boolean @default(false)
  order       Int     @default(0) 
  
  gptModel    String  @default("gpt-5.2") 
  systemPrompt String @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  subscriptionPlans SubscriptionPlan[]
  
  @@map("gpt_products")
}

model SubscriptionPlan {
  id          String       @id @default(uuid())
  name        String
  description String?      @db.Text
  price       Decimal      @db.Decimal(10, 2)
  duration    PlanDuration
  features    Json?        
  isActive    Boolean      @default(true)
  maxRequests Int?         
  stripePriceId String?    @unique
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  gptProductId String
  gptProduct   GptProduct  @relation(fields: [gptProductId], references: [id], onDelete: Cascade)
  
  subscriptions UserSubscription[]
  
  @@map("subscription_plans")
}

model UserSubscription {
  id              String             @id @default(uuid())
  status          SubscriptionStatus @default(TRIAL)
  
  startDate       DateTime           @default(now())
  endDate         DateTime?
  cancelledAt     DateTime?
  
  requestsUsed    Int                @default(0)
  lastResetDate   DateTime           @default(now())
  
  stripeSubscriptionId String?       @unique
  stripeCustomerId     String?
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  userId          String
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  planId          String
  plan            SubscriptionPlan   @relation(fields: [planId], references: [id])
  
  @@index([userId, status])
  @@map("user_subscriptions")
}

model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique 
  status          OrderStatus   @default(PENDING)
  
  subtotal        Decimal       @db.Decimal(10, 2)
  tax             Decimal       @db.Decimal(10, 2) @default(0)
  total           Decimal       @db.Decimal(10, 2)
  
  planDetails     Json         
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  
  payments        Payment[]
  
  @@index([userId, status])
  @@map("orders")
}

model Payment {
  id              String        @id @default(uuid())
  amount          Decimal       @db.Decimal(10, 2)
  status          PaymentStatus @default(PENDING)
  
  paymentMethod   String        
  
  stripePaymentIntentId String? @unique
  stripeChargeId        String?
  
  metadata        Json?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  orderId         String
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("payments")
}

model ApiKey {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String  
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  
  requestCount Int     @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, isActive])
  @@map("api_keys")
}

model ContactMessage {
  id        String   @id @default(uuid())
  name      String
  email     String
  subject   String?
  message   String   @db.Text
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@map("contact_messages")
}

// ===================================================
// CHAT FEEDBACK MODEL FOR RATINGS
// ===================================================
model ChatFeedback {
  id              String         @id @default(uuid())
  
  sessionId       String
  messageIndex    Int
  userMessage     String         @db.Text
  aiResponse      String         @db.Text
  
  rating          FeedbackRating
  comment         String?        @db.Text
  
  agentType       String?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, sessionId])
  @@index([rating, createdAt])
  @@map("chat_feedback")
}

// ===================================================
// CHAT SESSION & MESSAGE HISTORY
// ===================================================

model ChatSession {
  id              String        @id @default(uuid())
  
  // Session metadata
  title           String        
  agentType       String        @default("deal-hunter")
  
  // Session state
  isPinned        Boolean       @default(false)
  isArchived      Boolean       @default(false)
  
  // Conversation summary (for quick preview)
  summary         String?       @db.Text
  
  // Message count for quick access
  messageCount    Int           @default(0)
  
  // Last activity timestamp
  lastMessageAt   DateTime      @default(now())
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  messages        ChatMessage[]
  
  @@index([userId, lastMessageAt(sort: Desc)])
  @@index([userId, isPinned, lastMessageAt(sort: Desc)])
  @@map("chat_sessions")
}

model ChatMessage {
  id              String        @id @default(uuid())
  
  // Message content
  role            String        
  content         String        @db.Text
  
  // Message metadata
  messageIndex    Int           
  tokenCount      Int?          //Track token usage
  
  // File attachments (if any)
  hasFile         Boolean       @default(false)
  fileData        Json?         // Store file metadata if needed
  
  createdAt       DateTime      @default(now())
  
  // Relations
  sessionId       String
  session         ChatSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId, messageIndex])
  @@map("chat_messages")
}